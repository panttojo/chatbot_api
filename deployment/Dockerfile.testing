FROM python:3.12-slim

LABEL maintainer="The Five Hundred Band"

# Install system dependencies and UV
RUN apt-get update \
    && apt-get install -y --no-install-recommends curl bash git \
    && rm -rf /var/lib/apt/lists/* \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && export PATH="/root/.local/bin:$PATH" \
    && uv pip install --system --upgrade pip

# Copy only dependency files first for better caching
COPY pyproject.toml uv.lock /app/
WORKDIR /app

# Install Python dependencies
RUN export PATH="/root/.local/bin:$PATH" \
    && uv pip install --system . --group dev --group testing \
    && rm -rf /root/.cache

# Copy the rest of the application
COPY . /app

# Setup environment and testing
RUN mkdir -p reports

# Run tests
CMD ["/bin/bash", "-c", "coverage run -m pytest -s -v --lf && coverage report"]
